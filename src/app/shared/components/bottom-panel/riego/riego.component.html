<div class="riego-container">

  <div class="main-content">
    <!-- Grid de Plantas -->
    <div class="plants-grid-container">
      <div class="grid-wrapper">
        <div 
          class="plants-grid" 
          [style.grid-template-columns]="'repeat(' + gridSize + ', 1fr)'"
          [style.grid-template-rows]="'repeat(' + gridSize + ', 1fr)'"
        >
          <div 
            *ngFor="let row of [].constructor(gridSize); let r = index"
            class="grid-row"
          >
            <div 
              *ngFor="let col of [].constructor(gridSize); let c = index"
              class="grid-cell"
              [style.background-color]="getCellColor(getPlantAt(r, c))"
              [appPlantTooltip]="getPlantAt(r, c)"
              (mouseenter)="onCellHover(getPlantAt(r, c))"
              (mouseleave)="onCellHover(null)"
              (click)="onCellClick(getPlantAt(r, c))"
            >
              <div *ngIf="getPlantAt(r, c)" class="plant-icon">
                {{ getPlantIcon(getPlantAt(r, c)!) }}
              </div>
              <!-- Indicador de nivel de agua -->
              <div *ngIf="getPlantAt(r, c)" class="water-indicator">
                <div 
                  class="water-level"
                  [style.height]="getPlantAt(r, c)!.waterLevel + '%'"
                ></div>
              </div>
              <!-- Indicador de salud -->
              <div *ngIf="getPlantAt(r, c)" class="health-indicator">
                <span class="health-icon">{{ (getPlantAt(r, c)! | plantHealthStatus:'icon') }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Panel de Informaci√≥n -->
    <div class="info-panels">
      <!-- Informaci√≥n de Planta Seleccionada -->
      <div class="info-panel plant-info" *ngIf="selectedPlant">
        <h3>üå± Informaci√≥n del Cultivo</h3>
        <div class="plant-details">
          <div class="detail-item">
            <span class="label">Tipo:</span>
            <span class="value">{{ selectedPlant.type }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Estado:</span>
            <span class="value" [style.color]="(selectedPlant | plantHealthStatus:'color')">
              {{ selectedPlant | plantHealthStatus:'status' }}
            </span>
          </div>
          <div class="detail-item">
            <span class="label">Crecimiento:</span>
            <div class="progress-container">
              <div 
                class="progress-bar" 
                [style.width]="selectedPlant.growth + '%'"
                [style.background-color]="getHealthColor(selectedPlant.growth)"
              ></div>
              <span class="percentage">{{ selectedPlant.growth }}%</span>
            </div>
          </div>
          <div class="detail-item">
            <span class="label">Salud:</span>
            <div class="progress-container">
              <div 
                class="progress-bar" 
                [style.width]="selectedPlant.health + '%'"
                [style.background-color]="getHealthColor(selectedPlant.health)"
              ></div>
              <span class="percentage">{{ selectedPlant.health }}%</span>
            </div>
          </div>
          <div class="detail-item">
            <span class="label">Agua:</span>
            <div class="progress-container">
              <div 
                class="progress-bar" 
                [style.width]="selectedPlant.waterLevel + '%'"
                [style.background-color]="selectedPlant.waterLevel | waterLevelColor"
              ></div>
              <span class="percentage" [style.color]="selectedPlant.waterLevel | waterLevelColor">
                {{ selectedPlant.waterLevel }}% ({{ selectedPlant.waterLevel | waterLevelColor:'status' }})
              </span>
            </div>
          </div>
          <div class="detail-item">
            <span class="label">D√≠as para cosecha:</span>
            <span class="value days">{{ selectedPlant.daysToHarvest }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Rendimiento est.:</span>
            <span class="value yield">{{ selectedPlant.expectedYield.toFixed(1) }} kg/m¬≤</span>
          </div>
          <div class="detail-item">
            <span class="label">Recomendaci√≥n:</span>
            <span class="recommendation-text">{{ selectedPlant | plantHealthStatus:'recommendation' }}</span>
          </div>
        </div>

        <!-- Botones de Acci√≥n de Riego -->
        <div class="action-group">
          <h4>üíß Riegos</h4>
          <div class="action-buttons">
            <button class="action-btn" (click)="onActionClick('Riego Manual')">Riego Manual</button>
            <button class="action-btn" (click)="onActionClick('Auto-Riego')">Auto-Riego</button>
            <button class="action-btn" (click)="onActionClick('Drenaje')">Drenaje</button>
            <button class="action-btn" (click)="onActionClick('Aspersores')">Aspersores</button>
            <button class="action-btn" (click)="onActionClick('Goteo')">Goteo</button>
            <button class="action-btn" (click)="onActionClick('Programar')">Programar</button>
          </div>
        </div>

        <!-- Bot√≥n de Riego R√°pido -->
        <button class="water-btn" (click)="waterPlant(selectedPlant)">
          üíß Riego R√°pido (+20%)
        </button>
      </div>

      <!-- Informaci√≥n Clim√°tica NASA -->
      <div class="info-panel weather-info">
        <h3>
          <svg class="weather-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          Clima Actual
          <span class="nasa-badge">NASA</span>
        </h3>
        
        <div class="weather-details">
          <div class="weather-item">
            <span class="weather-icon-small">üå°Ô∏è</span>
            <span class="label">Temperatura:</span>
            <span class="value temperature">{{ weatherData.temperature.toFixed(1) }}¬∞C</span>
          </div>
          
          <div class="weather-item">
            <span class="weather-icon-small">üíß</span>
            <span class="label">Humedad:</span>
            <span class="value humidity">{{ weatherData.humidity.toFixed(0) }}%</span>
          </div>
          
          <div class="weather-item">
            <span class="weather-icon-small">üí®</span>
            <span class="label">Viento:</span>
            <span class="value wind">{{ weatherData.windSpeed.toFixed(1) }} km/h</span>
          </div>
          
          <div class="weather-item">
            <span class="weather-icon-small">‚òÄÔ∏è</span>
            <span class="label">UV Index:</span>
            <span 
              class="value uv-index"
              [style.color]="getUVIndexColor(weatherData.uvIndex)"
            >{{ weatherData.uvIndex.toFixed(1) }}</span>
          </div>
          
          <div class="weather-item">
            <span class="weather-icon-small">üåÄ</span>
            <span class="label">Presi√≥n:</span>
            <span class="value pressure">{{ weatherData.pressure }} hPa</span>
          </div>

          <div class="weather-item">
            <span class="weather-icon-small">üëÅÔ∏è</span>
            <span class="label">Visibilidad:</span>
            <span class="value">{{ weatherData.visibility || 15 }} km</span>
          </div>
        </div>

        <!-- Alertas Meteorol√≥gicas -->
        <div class="weather-alerts">
          <div 
            *ngFor="let alert of weatherData.alerts"
            class="alert"
            [ngClass]="{'drought': alert.includes('Sequ√≠a'), 'rain': alert.includes('lluvia'), 'flood': alert.includes('inundaci√≥n')}"
          >
            <span class="alert-icon">‚ö†Ô∏è</span>
            {{ alert }}
          </div>
        </div>

        <!-- Predicci√≥n con IA -->
        <div class="ai-predictions">
          <h4>ü§ñ Predicci√≥n IA</h4>
          <p class="prediction-text">Lluvia intensa el viernes</p>
          <p class="prediction-confidence">Confianza: 92%</p>
          <button class="nasa-data-btn" (click)="openNasaDataCenter()">
            üõ∞Ô∏è Abrir Centro de Datos NASA
          </button>
        </div>
      </div>

      <!-- Recomendaciones IA -->
      <div class="info-panel ai-recommendations">
        <h3>
          <span class="ai-icon">ü§ñ</span>
          Recomendaciones IA
        </h3>
        
        <div class="recommendations-list">
          <div 
            *ngFor="let rec of aiRecommendations"
            class="recommendation"
            [ngClass]="rec.type"
          >
            <div class="rec-header">
              <span class="priority">Prioridad {{ rec.priority }}</span>
              <span class="rec-type">{{ rec.type.toUpperCase() }}</span>
            </div>
            <p class="rec-message">{{ rec.message }}</p>
            <div class="rec-confidence">Confianza: {{ (rec.confidence * 100).toFixed(0) }}%</div>
          </div>
        </div>

        <div class="ai-insights">
          <h4>üí° An√°lisis Predictivo</h4>
          <ul class="insights-list">
            <li *ngFor="let insight of aiInsights">{{ insight }}</li>
          </ul>
        </div>

        <!-- Control de IA -->
        <div class="ai-controls">
          <h4>‚öôÔ∏è Control de IA</h4>
          <div class="control-buttons">
            <button class="control-btn" (click)="runAIAnalysis()" [disabled]="isAnalyzing">
              {{ isAnalyzing ? '‚è≥ Analizando...' : 'üîç Ejecutar An√°lisis' }}
            </button>
            <button class="control-btn secondary" (click)="toggleAutoMode()">
              {{ autoModeEnabled ? '‚è∏Ô∏è Pausar Auto' : '‚ñ∂Ô∏è Modo Auto' }}
            </button>
          </div>
          <div class="ai-status">
            <span class="status-indicator" [class.active]="autoModeEnabled"></span>
            Estado: {{ autoModeEnabled ? 'Autom√°tico' : 'Manual' }}
          </div>
        </div>
      </div>

      <!-- Panel de Estad√≠sticas Generales -->
      <div class="info-panel stats-panel">
        <h3>üìä Estad√≠sticas del Sistema</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value">{{ getTotalPlants() }}</div>
            <div class="stat-label">Plantas Totales</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" [style.color]="getHealthyPlantsColor()">{{ getHealthyPlants() }}</div>
            <div class="stat-label">Plantas Sanas</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" [style.color]="getCriticalPlantsColor()">{{ getCriticalPlants() }}</div>
            <div class="stat-label">Cr√≠ticas</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ getAverageWaterLevel().toFixed(1) }}%</div>
            <div class="stat-label">Agua Promedio</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ getEstimatedHarvest().toFixed(1) }}</div>
            <div class="stat-label">Cosecha Est. (kg)</div>
          </div>
          <div class="stat-item">
            <div class="stat-value">{{ getDaysToNextHarvest() }}</div>
            <div class="stat-label">D√≠as Pr√≥x. Cosecha</div>
          </div>
        </div>

        <!-- Progreso de la temporada -->
        <div class="season-progress">
          <h4>üìÖ Progreso de Temporada</h4>
          <div class="progress-container season">
            <div class="progress-bar" [style.width]="getSeasonProgress() + '%'"></div>
            <span class="percentage">{{ getSeasonProgress().toFixed(1) }}%</span>
          </div>
          <div class="season-info">
            <span>D√≠a {{ getCurrentSeasonDay() }} de {{ getTotalSeasonDays() }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Programaci√≥n de Riego -->
  <div class="modal-overlay" *ngIf="showScheduleModal" (click)="closeScheduleModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>‚è∞ Programar Riego</h3>
        <button class="close-btn" (click)="closeScheduleModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="schedule-form">
          <div class="form-group">
            <label>Tipo de Riego:</label>
            <select [(ngModel)]="scheduleForm.type">
              <option value="manual">Manual</option>
              <option value="auto">Autom√°tico</option>
              <option value="goteo">Goteo</option>
              <option value="aspersores">Aspersores</option>
            </select>
          </div>
          <div class="form-group">
            <label>Frecuencia:</label>
            <select [(ngModel)]="scheduleForm.frequency">
              <option value="daily">Diario</option>
              <option value="weekly">Semanal</option>
              <option value="custom">Personalizado</option>
            </select>
          </div>
          <div class="form-group">
            <label>Hora de Inicio:</label>
            <input type="time" [(ngModel)]="scheduleForm.startTime">
          </div>
          <div class="form-group">
            <label>Duraci√≥n (minutos):</label>
            <input type="number" [(ngModel)]="scheduleForm.duration" min="1" max="120">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" (click)="closeScheduleModal()">Cancelar</button>
        <button class="modal-btn primary" (click)="saveSchedule()">Guardar Programaci√≥n</button>
      </div>
    </div>
  </div>

  <!-- Notificaciones Toast -->
  <div class="toast-container">
    <div 
      *ngFor="let notification of notifications; let i = index"
      class="toast"
      [ngClass]="notification.type"
    >
      <span class="toast-icon">{{ getNotificationIcon(notification.type) }}</span>
      <span class="toast-message">{{ notification.message }}</span>
      <button class="toast-close" (click)="dismissNotification(i)">‚úï</button>
    </div>
  </div>
</div>